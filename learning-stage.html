<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Learning - Prompt Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #059669;
        }
        body { font-family: 'Inter', sans-serif; background-color: #0F0F1E; color: #F9FAFB; }
        #vanta-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .main-content { position: relative; z-index: 1; }
        .font-display { font-family: 'Poppins', sans-serif; }
        .gradient-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="vanta-background"></div>
    
    <!-- Nav -->
    <nav class="bg-white/10 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-white/10 relative z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="learning.html" class="font-display font-bold text-xl text-white flex items-center gap-2 hover:text-indigo-300 transition-colors">
                <span>‚Üê</span> Back to Hub
            </a>
            <a href="challenges.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                Start Challenges
            </a>
        </div>
    </nav>

    <main class="main-content max-w-4xl mx-auto px-4 py-12 min-h-screen">
        <div id="loading" class="text-center text-2xl text-gray-400 mt-20 animate-pulse">
            Loading mission data...
        </div>

        <div id="error-display" class="hidden text-center mt-20">
            <div class="text-6xl mb-4">üöß</div>
            <h2 class="text-2xl font-bold text-white mb-2">Under Construction</h2>
            <p class="text-gray-400" id="error-message"></p>
            <a href="learning.html" class="inline-block mt-6 px-6 py-3 bg-white/10 rounded-lg hover:bg-white/20 transition-colors">Return to Base</a>
        </div>

        <div id="stage-content" class="hidden space-y-12">
            <!-- Header -->
            <header class="text-center space-y-4">
                <span id="stage-badge" class="inline-block px-4 py-1 bg-indigo-500/20 text-indigo-300 rounded-full text-sm font-bold border border-indigo-500/30"></span>
                <h1 id="stage-title" class="font-display text-4xl md:text-6xl font-bold gradient-text pb-2"></h1>
                <div class="flex justify-center gap-6 text-gray-400 text-sm font-medium">
                    <span class="flex items-center gap-2">‚è±Ô∏è <span id="stage-time"></span></span>
                    <span class="flex items-center gap-2">üéØ <span id="stage-objectives-count"></span> Objectives</span>
                </div>
            </header>

            <!-- Theory -->
            <section class="glass-card rounded-2xl p-8">
                <h2 class="font-display text-2xl font-bold text-white mb-6 flex items-center gap-3">
                    <span class="text-3xl">üìñ</span> Briefing
                </h2>
                <p id="theory-text" class="text-lg text-gray-300 leading-relaxed mb-8"></p>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-emerald-900/20 rounded-xl p-6 border border-emerald-500/20">
                        <h3 class="font-bold text-emerald-400 mb-4 flex items-center gap-2">‚úÖ Key Principles</h3>
                        <ul id="theory-principles" class="space-y-3 text-emerald-100/80"></ul>
                    </div>
                    <div class="bg-red-900/20 rounded-xl p-6 border border-red-500/20">
                        <h3 class="font-bold text-red-400 mb-4 flex items-center gap-2">‚ùå Common Mistakes</h3>
                        <ul id="theory-mistakes" class="space-y-3 text-red-100/80"></ul>
                    </div>
                </div>
            </section>

            <!-- Examples -->
            <section>
                <h2 class="font-display text-2xl font-bold text-white mb-6 flex items-center gap-3">
                    <span class="text-3xl">üí°</span> Field Examples
                </h2>
                <div id="examples-list" class="space-y-6"></div>
            </section>

            <!-- Exercises -->
            <section>
                <h2 class="font-display text-2xl font-bold text-white mb-6 flex items-center gap-3">
                    <span class="text-3xl">‚ö°</span> Training Simulations
                </h2>
                <div id="exercises-list" class="grid gap-6"></div>
            </section>
            
            <!-- Footer Nav -->
            <div class="flex justify-between pt-8 border-t border-white/10">
                <a href="learning.html" class="text-gray-400 hover:text-white transition-colors">‚Üê Back to Hub</a>
                <a href="challenges.html" class="text-indigo-400 hover:text-indigo-300 font-bold transition-colors">Ready for Challenges ‚Üí</a>
            </div>
        </div>
    </main>

    <script>
        // Stage mapping
        const STAGE_FILES = {
            '1': 'content/stage1_essentials.json',
            '2': 'content/stage2_personas.json',
            '3': 'content/stage3_formatting.json',
            '4': 'content/stage4_constraints.json',
            '5': 'content/stage5_iteration.json'
        };

        async function init() {
            // Vanta
            if (typeof VANTA !== 'undefined') {
                VANTA.NET({
                    el: "#vanta-background",
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: 0x4f46e5,
                    backgroundColor: 0x0f0f1e,
                    points: 10.00,
                    maxDistance: 20.00,
                    spacing: 15.00
                });
            }

            // Load Content
            const params = new URLSearchParams(window.location.search);
            const stage = params.get('stage');
            const file = STAGE_FILES[stage];

            if (!file) {
                showError("Stage configuration not found.");
                return;
            }

            try {
                console.log('Attempting to load:', file);
                const response = await fetch(file);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Data loaded successfully:', data.stageMetadata.title);
                renderContent(data);
            } catch (e) {
                console.error('Error loading stage:', e);
                console.error('File path:', file);
                showError(`Error loading stage content: ${e.message}. Please refresh the page or try again later.`);
            }
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-display').classList.remove('hidden');
            document.getElementById('error-message').textContent = msg;
        }

        function renderContent(data) {
            const meta = data.stageMetadata;
            const theory = data.theorySection;

            // Metadata
            document.getElementById('stage-badge').textContent = `Stage ${meta.stageNumber}`;
            document.getElementById('stage-title').textContent = meta.title;
            document.getElementById('stage-time').textContent = meta.estimatedTime;
            document.getElementById('stage-objectives-count').textContent = meta.learningObjectives.length;

            // Theory
            document.getElementById('theory-text').innerHTML = theory.explanation.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>');
            
            renderList('theory-principles', theory.keyPrinciples);
            renderList('theory-mistakes', theory.commonMistakes);

            // Examples
            const examplesContainer = document.getElementById('examples-list');
            data.workedExamples.forEach(ex => {
                const div = document.createElement('div');
                div.className = 'glass-card rounded-xl overflow-hidden';
                div.innerHTML = `
                    <div class="p-6 border-b border-white/10">
                        <p class="text-gray-300 text-lg">${ex.explanation}</p>
                    </div>
                    <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10">
                        <div class="p-6 bg-red-900/10">
                            <div class="text-xs font-bold text-red-400 uppercase tracking-wider mb-2">Weak Prompt</div>
                            <p class="text-red-100 font-mono text-sm">"${ex.badPrompt}"</p>
                        </div>
                        <div class="p-6 bg-emerald-900/10">
                            <div class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-2">Strong Prompt</div>
                            <p class="text-emerald-100 font-mono text-sm">"${ex.goodPrompt}"</p>
                        </div>
                    </div>
                    <div class="p-4 bg-black/30 border-t border-white/10">
                        <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Expected Output Preview</div>
                        <p class="text-gray-400 italic text-sm">${ex.expectedOutputPreview}</p>
                    </div>
                `;
                examplesContainer.appendChild(div);
            });

            // Exercises
            const exercisesContainer = document.getElementById('exercises-list');
            data.interactiveExercises.forEach((ex, i) => {
                const div = document.createElement('div');
                div.className = 'glass-card rounded-xl p-6 hover:bg-white/5 transition-colors cursor-pointer group';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-xs font-mono text-indigo-400 mb-1 block">${ex.exerciseId}</span>
                            <h3 class="text-xl font-bold text-white group-hover:text-indigo-300 transition-colors">${ex.title}</h3>
                        </div>
                        <span class="px-3 py-1 bg-yellow-500/20 text-yellow-300 rounded-full text-xs font-bold">+${ex.xpReward} XP</span>
                    </div>
                    <p class="text-gray-300 mb-4">${ex.taskDescription}</p>
                    
                    <!-- Hidden/Expandable Content -->
                    <div class="hidden-content hidden mt-6 pt-6 border-t border-white/10 space-y-4">
                        <div class="bg-black/30 p-4 rounded-lg">
                            <div class="text-xs text-gray-500 uppercase mb-2">Scenario</div>
                            <p class="text-gray-300 text-sm">${ex.scenario}</p>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 uppercase mb-2">Success Criteria</div>
                            <ul class="space-y-1">
                                ${ex.successCriteria.map(c => `<li class="text-sm text-gray-400 flex items-center gap-2"><span class="text-indigo-500">‚óã</span> ${c}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="bg-indigo-900/20 p-4 rounded-lg border border-indigo-500/20">
                            <div class="text-xs text-indigo-400 uppercase mb-2">Model Answer (Hidden)</div>
                            <p class="text-indigo-100 font-mono text-sm filter blur-sm hover:blur-none transition-all cursor-help select-all">${ex.modelAnswer}</p>
                            <p class="text-xs text-center text-indigo-500/50 mt-1">(Hover to reveal)</p>
                        </div>
                    </div>
                    
                    <div class="text-center mt-2">
                        <span class="text-xs text-gray-600 group-hover:text-gray-400 transition-colors">Click to expand/collapse</span>
                    </div>
                `;
                
                // Toggle logic
                div.onclick = function(e) {
                    const content = this.querySelector('.hidden-content');
                    content.classList.toggle('hidden');
                };
                
                exercisesContainer.appendChild(div);
            });

            // Show content
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('stage-content').classList.remove('hidden');
            
            // Animate in
            anime({
                targets: '#stage-content > *',
                opacity: [0, 1],
                translateY: [20, 0],
                delay: anime.stagger(100),
                easing: 'easeOutQuart'
            });
        }

        function renderList(id, items) {
            const el = document.getElementById(id);
            el.innerHTML = items.map(item => {
                const text = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                return `<li class="flex items-start gap-2"><span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-current opacity-50"></span><span>${text}</span></li>`;
            }).join('');
        }

        init();
    </script>
</body>
</html>
